---
import Layout from "@/layouts/Layout.astro";
import { FileText, User, Phone, Mail, CalendarIcon, MapPin, Briefcase, Car, Bus, BookOpen } from "@lucide/astro";

const today = new Date().toISOString().split('T')[0];
---

<Layout>
  <div class="max-w-4xl mx-auto p-6">
   
    <!-- Detalles del empleo -->
    <div id="job-details" class="mb-6 bg-white rounded-lg shadow-md border border-gray-200 p-6 hidden">
      <h2 class="text-xl font-semibold text-gray-900 mb-4 flex items-center">
        <Briefcase class="w-5 h-5 mr-2" />
        Detalles del Empleo
      </h2>
      <div class="space-y-3">
        <div>
          <span class="font-semibold text-gray-700">Puesto:</span>
          <span id="job-puesto" class="ml-2 text-gray-900"></span>
        </div>
        <div>
          <span class="font-semibold text-gray-700">Ubicación:</span>
          <span id="job-ubicacion" class="ml-2 text-gray-900"></span>
        </div>
        <div>
          <span class="font-semibold text-gray-700">Puestos disponibles:</span>
          <span id="job-puestos-disponibles" class="ml-2 text-gray-900"></span>
        </div>
        <div>
          <span class="font-semibold text-gray-700">Fecha de publicación:</span>
          <span id="job-fecha" class="ml-2 text-gray-900"></span>
        </div>
        <div id="job-descripcion-container" class="hidden">
          <span class="font-semibold text-gray-700">Descripción:</span>
          <div id="job-descripcion" class="ml-2 mt-2 text-gray-900 prose prose-sm"></div>
        </div>
      </div>
    </div>

    <!-- Mensaje de error -->
    <div id="error-message" class="mb-6 p-4 bg-red-50 border border-red-200 rounded-lg hidden">
      <p class="text-sm text-red-800"></p>
    </div>

    <!-- Formulario -->
    <div class="bg-white rounded-lg shadow-md border border-gray-200">
      <div class="p-6">
        <h2 class="text-xl font-semibold text-gray-900 mb-6 flex items-center">
          <FileText class="w-5 h-5 mr-2" />
          Formulario de aplicación
        </h2>

        <form class="space-y-8" id="job-application-form">
          {/* Fecha de aplicación y Vacante */}
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <label for="fecha_aplicacion" class="block text-sm font-medium text-gray-700 mb-2">
                Fecha de Aplicación *
              </label>
              <div class="relative">
                <CalendarIcon class="w-4 h-4 absolute left-3 top-3 text-gray-400" />
                <input 
                  type="date" 
                  id="fecha_aplicacion" 
                  name="fecha_aplicacion" 
                  required
                  readonly
                  value={today}
                  class="w-full pl-10 pr-3 py-2 border border-gray-300 rounded-md bg-gray-50 text-gray-700 cursor-not-allowed"
                />
              </div>
            </div>

            <div>
              <label for="vacante_deseada" class="block text-sm font-medium text-gray-700 mb-2">
                Vacante deseada *
              </label>
              <div class="relative">
                <Briefcase class="w-4 h-4 absolute left-3 top-3 text-gray-400" />
                <input 
                  type="text" 
                  id="vacante_deseada" 
                  name="vacante_deseada" 
                  required
                  readonly
                  class="w-full pl-10 pr-3 py-2 border border-gray-300 rounded-md bg-gray-50 text-gray-700"
                />
              </div>
            </div>
          </div>

          {/* Información personal */}
          <div class="border-t pt-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
              <User class="w-5 h-5 mr-2" />
              Información Personal
            </h3>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
              <div>
                <label for="nombre" class="block text-sm font-medium text-gray-700 mb-2">
                  Nombre(s) *
                </label>
                <input 
                  type="text" 
                  id="nombre" 
                  name="nombre" 
                  required
                  placeholder="Nombre(s)"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                />
              </div>

              <div>
                <label for="apellido_paterno" class="block text-sm font-medium text-gray-700 mb-2">
                  Apellido Paterno *
                </label>
                <input 
                  type="text" 
                  id="apellido_paterno" 
                  name="apellido_paterno" 
                  required
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                />
              </div>

              <div>
                <label for="apellido_materno" class="block text-sm font-medium text-gray-700 mb-2">
                  Apellido Materno *
                </label>
                <input 
                  type="text" 
                  id="apellido_materno" 
                  name="apellido_materno" 
                  required
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                />
              </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                  Género *
                </label>
                <div class="flex space-x-4">
                  <label class="flex items-center">
                    <input type="radio" name="genero" value="masculino" required class="mr-2" />
                    Masculino
                  </label>
                  <label class="flex items-center">
                    <input type="radio" name="genero" value="femenino" required class="mr-2" />
                    Femenino
                  </label>
                  <label class="flex items-center">
                    <input type="radio" name="genero" value="otro" required class="mr-2" />
                    Otro
                  </label>
                </div>
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                  Estado civil *
                </label>
                <div class="grid grid-cols-2 gap-2">
                  <label class="flex items-center">
                    <input type="radio" name="estado_civil" value="soltero" required class="mr-2" />
                    Soltero/a
                  </label>
                  <label class="flex items-center">
                    <input type="radio" name="estado_civil" value="casado" required class="mr-2" />
                    Casado/a
                  </label>
                  <label class="flex items-center">
                    <input type="radio" name="estado_civil" value="viudo" required class="mr-2" />
                    Viudo/a
                  </label>
                  <label class="flex items-center">
                    <input type="radio" name="estado_civil" value="divorciado" required class="mr-2" />
                    Divorciado/a
                  </label>
                </div>
              </div>
            </div>
          </div>

          {/* Información de contacto */}
          <div class="border-t pt-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
              <Phone class="w-5 h-5 mr-2" />
              Información de Contacto
            </h3>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div>
                <label for="telefono" class="block text-sm font-medium text-gray-700 mb-2">
                  Teléfono *
                </label>
                <div class="relative">
                  <Phone class="w-4 h-4 absolute left-3 top-3 text-gray-400" />
                  <input 
                    type="tel" 
                    id="telefono" 
                    name="telefono" 
                    required
                    placeholder="+52 123 456 7890"
                    class="w-full pl-10 pr-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  />
                </div>
              </div>

              <div>
                <label for="email" class="block text-sm font-medium text-gray-700 mb-2">
                  Correo electrónico *
                </label>
                <div class="relative">
                  <Mail class="w-4 h-4 absolute left-3 top-3 text-gray-400" />
                  <input 
                    type="email" 
                    id="email" 
                    name="email" 
                    required
                    placeholder="tu.email@ejemplo.com"
                    class="w-full pl-10 pr-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  />
                </div>
              </div>

              <div>
                <label for="fecha_nacimiento" class="block text-sm font-medium text-gray-700 mb-2">
                  Fecha de nacimiento *
                </label>
                <div class="relative">
                  <CalendarIcon class="w-4 h-4 absolute left-3 top-3 text-gray-400" />
                  <input 
                    type="date" 
                    id="fecha_nacimiento" 
                    name="fecha_nacimiento" 
                    required
                    class="w-full pl-10 pr-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  />
                </div>
              </div>

              <div>
                <label for="codigo_postal" class="block text-sm font-medium text-gray-700 mb-2">
                  Código Postal
                </label>
                <div class="relative">
                  <MapPin class="w-4 h-4 absolute left-3 top-3 text-gray-400" />
                  <input 
                    type="text" 
                    id="codigo_postal" 
                    name="codigo_postal" 
                    placeholder="45000"
                    class="w-full pl-10 pr-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  />
                </div>
              </div>
            </div>
          </div>

          {/* Medio de empleo */}
          <div class="border-t pt-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">
              ¿Cómo te enteraste de esta vacante? *
            </h3>
            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4">
              <label class="flex items-center">
                <input type="radio" name="medio_empleo" value="facebook" required class="mr-2" />
                Facebook
              </label>
              <label class="flex items-center">
                <input type="radio" name="medio_empleo" value="indeed" required class="mr-2" />
                Indeed
              </label>
              <label class="flex items-center">
                <input type="radio" name="medio_empleo" value="computrabajo" required class="mr-2" />
                Computrabajo
              </label>
              <label class="flex items-center">
                <input type="radio" name="medio_empleo" value="sne" required class="mr-2" />
                SNE
              </label>
              <label class="flex items-center">
                <input type="radio" name="medio_empleo" value="pagina_web_une" required class="mr-2" />
                Página Web UNE
              </label>
              <label class="flex items-center">
                <input type="radio" name="medio_empleo" value="volante_plantel" required class="mr-2" />
                Volante/Plantel
              </label>
              <label class="flex items-center">
                <input type="radio" name="medio_empleo" value="modulo" required class="mr-2" />
                Módulo
              </label>
              <label class="flex items-center">
                <input type="radio" name="medio_empleo" value="talenteca" required class="mr-2" />
                Talenteca
              </label>
              <label class="flex items-center">
                <input type="radio" name="medio_empleo" value="recomendado" required class="mr-2" />
                Recomendado
              </label>
              <label class="flex items-center">
                <input type="radio" name="medio_empleo" value="otro" required class="mr-2" />
                Otro
              </label>
            </div>
          </div>

          {/* Escolaridad y Plantel */}
          <div class="border-t pt-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                  Escolaridad *
                </label>
                <div class="space-y-2">
                  <label class="flex items-center">
                    <input type="radio" name="escolaridad" value="medio_superior" required class="mr-2" />
                    Medio superior
                  </label>
                  <label class="flex items-center">
                    <input type="radio" name="escolaridad" value="superior" required class="mr-2" />
                    Superior
                  </label>
                  <label class="flex items-center">
                    <input type="radio" name="escolaridad" value="maestria" required class="mr-2" />
                    Maestría
                  </label>
                  <label class="flex items-center">
                    <input type="radio" name="escolaridad" value="doctorado" required class="mr-2" />
                    Doctorado
                  </label>
                </div>
              </div>

              <div>
                <label for="plantel" class="block text-sm font-medium text-gray-700 mb-2">
                  Plantel de interés *
                </label>
                <select 
                  id="plantel" 
                  name="plantel" 
                  required
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                >
                  <option value="">Seleccione un plantel</option>
                  <option value="av_mexico">Av. México</option>
                  <option value="casa_amarilla">Casa Amarilla</option>
                  <option value="centro">Centro</option>
                  <option value="centro_medico">Centro Médico</option>
                  <option value="centro_idiomas">Centro de Idiomas</option>
                  <option value="une_en_linea">UNE en Línea</option>
                  <option value="las_juntas">Las Juntas</option>
                  <option value="las_gaviotas">Las Gaviotas</option>
                  <option value="milenio">Milenio</option>
                  <option value="plaza_caracol">Plaza Caracol</option>
                  <option value="tesistan">Tesistán</option>
                  <option value="tlajomulco">Tlajomulco</option>
                  <option value="tlaquepaque">Tlaquepaque</option>
                  <option value="tonala">Tonalá</option>
                  <option value="torre_milenio">Torre Milenio</option>
                  <option value="torre_quetzal">Torre Quetzal</option>
                  <option value="torre_zafiro">Torre Zafiro</option>
                  <option value="vallarta">Vallarta</option>
                  <option value="zapopan">Zapopan</option>
                  <option value="tepatitlan">Tepatitlán</option>
                  <option value="campus_puerto_vallarta">Campus Puerto Vallarta</option>
                </select>
              </div>
            </div>
          </div>

          {/* Información médica y transporte */}
          <div class="border-t pt-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                  ¿Padece alguna discapacidad?
                </label>
                <div class="flex space-x-4">
                  <label class="flex items-center">
                    <input type="radio" name="discapacidad" value="si" class="mr-2" />
                    Sí
                  </label>
                  <label class="flex items-center">
                    <input type="radio" name="discapacidad" value="no" class="mr-2" checked />
                    No
                  </label>
                </div>
              </div>

              <div>
                <label for="medicamentos" class="block text-sm font-medium text-gray-700 mb-2">
                  Medicamentos (opcional)
                </label>
                <textarea 
                  id="medicamentos" 
                  name="medicamentos" 
                  rows="2"
                  placeholder="Liste medicamentos que toma regularmente"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                ></textarea>
              </div>
            </div>

            <div class="mt-6">
              <label class="block text-sm font-medium text-gray-700 mb-2">
                Medio de transporte *
              </label>
              <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <label class="flex items-center">
                  <input type="radio" name="medio_transporte" value="automovil" required class="mr-2" />
                  <Car class="w-4 h-4 mr-1" />
                  Automóvil
                </label>
                <label class="flex items-center">
                  <input type="radio" name="medio_transporte" value="transporte_publico" required class="mr-2" />
                  <Bus class="w-4 h-4 mr-1" />
                  Transporte Público
                </label>
                <label class="flex items-center">
                  <input type="radio" name="medio_transporte" value="motocicleta" required class="mr-2" />
                  Motocicleta
                </label>
                <label class="flex items-center">
                  <input type="radio" name="medio_transporte" value="bicicleta" required class="mr-2" />
                  Bicicleta
                </label>
              </div>
            </div>
          </div>

          {/* Campos ocultos */}
          <input type="hidden" name="puesto_id" id="puesto_id" />

          {/* Términos y condiciones */}
          <div class="border-t pt-6">
            <div class="flex items-start space-x-2">
              <input 
                type="checkbox" 
                id="terminos" 
                name="terminos" 
                required
                class="mt-1"
              />
              <label for="terminos" class="text-sm text-gray-600">
                Acepto los 
                <a href="/acerca/Terminos-condiciones" class="text-blue-600 hover:text-blue-700">términos y condiciones</a> 
                y autorizo el tratamiento de mis datos personales conforme a la 
                <a href="/acerca/Politicas" class="text-blue-600 hover:text-blue-700">política de privacidad</a>.
                Declaro que toda la información proporcionada es verdadera y completa.
              </label>
            </div>
          </div>

          {/* Botones */}
          <div class="flex flex-col sm:flex-row gap-4 pt-6">
            <button 
              type="submit"
              id="submit-button"
              class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-3 px-6 rounded-md font-medium transition-colors duration-200 flex items-center justify-center disabled:bg-gray-400 disabled:cursor-not-allowed"
            >
              <BookOpen class="w-4 h-4 mr-2" />
              <span id="submit-text">Enviar solicitud</span>
            </button>
            
            <a 
              href="/acerca/empleo"
              class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 py-3 px-6 rounded-md font-medium transition-colors duration-200 text-center flex items-center justify-center"
            >
              Cancelar
            </a>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Modal de error -->
  <div id="error-modal" class="hidden fixed inset-0  bg-opacity-50 flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-lg shadow-xl max-w-md w-full p-6">
      <div class="flex items-start mb-4">
        <div class="flex-shrink-0">
          <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
          </svg>
        </div>
        <div class="ml-3 flex-1">
          <h3 class="text-lg font-semibold text-gray-900 mb-2">Error al enviar solicitud</h3>
          <p id="modal-error-message" class="text-sm text-gray-600 mb-4"></p>
          <div class="text-sm text-gray-600 bg-gray-50 p-3 rounded border border-gray-200">
            <p class="font-semibold mb-1">Si el problema persiste:</p>
            <p>Por favor, envíe su solicitud por correo a:</p>
            <a href="mailto:informes@universidad-une.com" class="text-blue-600 hover:text-blue-700 font-medium">
              informes@universidad-une.com
            </a>
          </div>
        </div>
      </div>
      <div class="flex gap-3 mt-6">
        <button 
          id="retry-button"
          class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-md font-medium transition-colors"
        >
          Intentar de nuevo
        </button>
        <button 
          id="close-modal-button"
          class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 py-2 px-4 rounded-md font-medium transition-colors"
        >
          Cerrar
        </button>
      </div>
    </div>
  </div>

  <script>
    const API_URL = "https://intranet.universidad-une.com/api/getjobs";

    const urlParams = new URLSearchParams(window.location.search);
    const jobId = urlParams.get("id");

    const jobIdDisplay = document.getElementById("job-id-display");
    if (jobIdDisplay) {
      jobIdDisplay.textContent = jobId || "No detectado";
    }

    const puestoIdInput = document.getElementById("puesto_id");
    if (puestoIdInput && jobId) {
      puestoIdInput.value = jobId;
    }

    console.log("ID del empleo:", jobId);

    function showError(message) {
      const errorDiv = document.getElementById("error-message");
      if (errorDiv) {
        errorDiv.querySelector("p").textContent = message;
        errorDiv.classList.remove("hidden");
      }
    }

    function hideError() {
      const errorDiv = document.getElementById("error-message");
      if (errorDiv) {
        errorDiv.classList.add("hidden");
      }
    }

    function displayJobDetails(job) {
      const jobDetails = document.getElementById("job-details");
      
      if (jobDetails) {
        document.getElementById("job-puesto").textContent = job.puesto || "N/A";
        document.getElementById("job-ubicacion").textContent = job.ubicacion || "N/A";
        document.getElementById("job-puestos-disponibles").textContent = job.puestos_disponibles || "0";
        document.getElementById("job-fecha").textContent = job.fecha_publicacion || "N/A";
        
        const descripcionContainer = document.getElementById("job-descripcion-container");
        const descripcionDiv = document.getElementById("job-descripcion");
        
        if (job.descripcion && job.descripcion.trim() !== "" && job.descripcion !== "<p data-last-history-steps=\"1588989726754589\"><br></p>") {
          descripcionDiv.innerHTML = job.descripcion;
          descripcionContainer.classList.remove("hidden");
        } else {
          descripcionContainer.classList.add("hidden");
        }
        
        jobDetails.classList.remove("hidden");
        
        const vacanteInput = document.getElementById("vacante_deseada");
        if (vacanteInput) {
          vacanteInput.value = job.puesto;
        }
      }
    }

    async function fetchJobDetails() {
      if (!jobId) {
        showError("No se proporcionó un ID de empleo en la URL");
        return;
      }

      try {
        hideError();
        
        const response = await fetch(API_URL);
        
        if (!response.ok) {
          throw new Error(`Error en la petición: ${response.status}`);
        }
        
        const result = await response.json();
        
        if (result.status === "success" && result.data) {
          const job = result.data.find(j => j.id_empleo === parseInt(jobId));
          
          if (job) {
            console.log("Empleo encontrado:", job);
            displayJobDetails(job);
          } else {
            showError(`No se encontró ningún empleo con el ID: ${jobId}`);
          }
        } else {
          showError("La respuesta de la API no tiene el formato esperado");
        }
        
      } catch (error) {
        console.error("Error al obtener detalles del empleo:", error);
        showError(`Error al cargar los detalles del empleo: ${error.message}`);
      }
    }

    if (jobId) {
      fetchJobDetails();
    }

    const form = document.getElementById("job-application-form");
    const submitButton = document.getElementById("submit-button");
    const submitText = document.getElementById("submit-text");
    const errorModal = document.getElementById("error-modal");
    const modalErrorMessage = document.getElementById("modal-error-message");
    const retryButton = document.getElementById("retry-button");
    const closeModalButton = document.getElementById("close-modal-button");
    
    let lastFormData = null;
    
    function showErrorModal(message) {
      modalErrorMessage.textContent = message;
      errorModal.classList.remove("hidden");
    }
    
    function closeErrorModal() {
      errorModal.classList.add("hidden");
    }
    
    closeModalButton?.addEventListener("click", closeErrorModal);
    
    errorModal?.addEventListener("click", (e) => {
      if (e.target === errorModal) {
        closeErrorModal();
      }
    });
    
    async function submitForm(formData) {
      submitButton.disabled = true;
      submitText.textContent = "Enviando...";
      
      const payload = {
        tipo_formulario: "Formulario de aplicación",
        fecha_aplicacion: formData.get("fecha_aplicacion"),
        vacante_deseada: formData.get("vacante_deseada"),
        
        nombre: formData.get("nombre"),
        apellido_paterno: formData.get("apellido_paterno"),
        apellido_materno: formData.get("apellido_materno"),
        
        genero: formData.get("genero") === "masculino" ? "Masculino" : 
                formData.get("genero") === "femenino" ? "Femenino" : "Otro",
        estado_civil: formData.get("estado_civil") === "soltero" ? "Soltero/a" :
                      formData.get("estado_civil") === "casado" ? "Casado/a" :
                      formData.get("estado_civil") === "viudo" ? "Viudo/a" : "Divorciado/a",
        telefono: formData.get("telefono"),
        correo: formData.get("email"),
        fecha_nacimiento: formData.get("fecha_nacimiento"),
        
        medio_empleo: formatMedioEmpleo(formData.get("medio_empleo")),
        escolaridad: formatEscolaridad(formData.get("escolaridad")),
        plantel_docentes: formatPlantel(formData.get("plantel")),
        
        discapacidad: formData.get("discapacidad") === "si" ? "Sí" : "No",
        medicamentos: formData.get("medicamentos") || "",
        codigo_postal: formData.get("codigo_postal") || "",
        
        medio_transporte: formatMedioTransporte(formData.get("medio_transporte")),
        presentacion: ""
      };
      
      console.log("Payload a enviar:", payload);
      
      try {
        const response = await fetch('https://intranet.universidad-une.com/api/applyjob', {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(payload)
        });
        
        const data = await response.json();
        console.log("Respuesta de la API:", data);
        
        if (response.ok) {
          console.log("Solicitud enviada exitosamente");
          window.location.href = '/contacto/gracias-empleo';
        } else {
          throw new Error(data.message || "Error al procesar la solicitud");
        }
      } catch (error) {
        console.error("Error al enviar el formulario:", error);
        
        let errorMessage = "";
        if (!navigator.onLine) {
          errorMessage = "No hay conexión a internet. Por favor, verifica tu conexión e intenta nuevamente.";
        } else if (error.message === "Failed to fetch" || error.name === "TypeError") {
          errorMessage = "No se pudo conectar con el servidor. Esto puede deberse a problemas de conexión a internet. Por favor, intenta más tarde.";
        } else {
          errorMessage = `Ocurrió un error al enviar tu solicitud: ${error.message}. Por favor, intenta nuevamente.`;
        }
        
        showErrorModal(errorMessage);
      } finally {
        submitButton.disabled = false;
        submitText.textContent = "Enviar solicitud";
      }
    }
    
    form?.addEventListener("submit", async (e) => {
      e.preventDefault();
      lastFormData = new FormData(form);
      await submitForm(lastFormData);
    });
    
    retryButton?.addEventListener("click", async () => {
      closeErrorModal();
      if (lastFormData) {
        await submitForm(lastFormData);
      }
    });
    
    function formatMedioEmpleo(value) {
      const mapping = {
        "facebook": "Facebook",
        "indeed": "Indeed",
        "computrabajo": "Computrabajo",
        "sne": "SNE",
        "pagina_web_une": "Página Web UNE",
        "volante_plantel": "Volante/Plantel",
        "modulo": "Módulo",
        "talenteca": "Talenteca",
        "recomendado": "Recomendado",
        "otro": "Otro"
      };
      return mapping[value] || value;
    }
    
    function formatEscolaridad(value) {
      const mapping = {
        "medio_superior": "Medio superior",
        "superior": "Superior",
        "maestria": "Maestría",
        "doctorado": "Doctorado"
      };
      return mapping[value] || value;
    }
    
    function formatPlantel(value) {
      const mapping = {
        "av_mexico": "Av. México",
        "casa_amarilla": "Casa Amarilla",
        "centro": "Centro",
        "centro_medico": "Centro Médico",
        "centro_idiomas": "Centro de Idiomas",
        "une_en_linea": "UNE en Línea",
        "las_juntas": "Las Juntas",
        "las_gaviotas": "Las Gaviotas",
        "milenio": "Milenio",
        "plaza_caracol": "Plaza Caracol",
        "tesistan": "Tesistán",
        "tlajomulco": "Tlajomulco",
        "tlaquepaque": "Tlaquepaque",
        "tonala": "Tonalá",
        "torre_milenio": "Torre Milenio",
        "torre_quetzal": "Torre Quetzal",
        "torre_zafiro": "Torre Zafiro",
        "vallarta": "Vallarta",
        "zapopan": "Zapopan",
        "tepatitlan": "Tepatitlán",
        "campus_puerto_vallarta": "Campus Puerto Vallarta"
      };
      return mapping[value] || value;
    }
    
    function formatMedioTransporte(value) {
      const mapping = {
        "automovil": "Automóvil",
        "transporte_publico": "Transporte Público",
        "motocicleta": "Motocicleta",
        "bicicleta": "Bicicleta"
      };
      return mapping[value] || value;
    }
  </script>
</Layout>