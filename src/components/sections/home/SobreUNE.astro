---
// src/SobreUNE.astro
import { ArrowRight } from "@lucide/astro";
import Numeralia from "@assets/Imagenes/Middles/Numeralia.webp";
import NumeraliaMobile from "@assets/Imagenes/Middles/NumeraliaMobile.webp";

// Importar todas las imágenes del carousel para que Astro las procese
import BanamexLogo from "@assets/Logos/Convenios/Banamex-logo.webp";
import BarceloLogo from "@assets/Logos/Convenios/Barcelo.webp";
import BoschLogo from "@assets/Logos/Convenios/Bosch.webp";
import CklassLogo from "@assets/Logos/Convenios/cklass.webp";
import CONTPAQiLogo from "@assets/Logos/Convenios/CONTPAQi.webp";
import FarmaciaGuadalajaraLogo from "@assets/Logos/Convenios/farmacia-guadalajara-.webp";
import FiestaAmericanaLogo from "@assets/Logos/Convenios/FIESTA AMERICANA.webp";
import GDLLogo from "@assets/Logos/Convenios/GDL.webp";
import GPLogo from "@assets/Logos/Convenios/GP.webp";
import IEPCJaliscoLogo from "@assets/Logos/Convenios/IEPC_Jalisco.webp";
import JoyaLogo from "@assets/Logos/Convenios/joya.webp";
import TlajomulcoLogo from "@assets/Logos/Convenios/LOGO-TLAJOMULCO.webp";
import MaverLogo from "@assets/Logos/Convenios/MAVER.webp";
import MITLogo from "@assets/Logos/Convenios/MIT.webp";
import PeninsulaLogo from "@assets/Logos/Convenios/PENINSULA-RESIDENCES.webp";
import PresidenteLogo from "@assets/Logos/Convenios/presidente-continental-mexico.webp";
import QINLogo from "@assets/Logos/Convenios/QIN.webp";
import TlaquepaqueLogo from "@assets/Logos/Convenios/TLAQUEPQUE.webp";
import ZapopanLogo from "@assets/Logos/Convenios/zapopan.webp";
import ZFLogo from "@assets/Logos/Convenios/ZF.webp";
import UNELogo from "@assets/Logos/UNE_30.webp";

// Array con la información de los logos para mejor mantenimiento
const partnerLogos = [
  { src: BanamexLogo, alt: "Banamex", height: "h-20" },
  { src: BarceloLogo, alt: "Barceló", height: "h-48" },
  { src: BoschLogo, alt: "Bosch", height: "h-20" },
  { src: CklassLogo, alt: "Cklass", height: "h-12" },
  { src: CONTPAQiLogo, alt: "CONTPAQi", height: "h-12" },
  { src: FarmaciaGuadalajaraLogo, alt: "Farmacia Guadalajara", height: "h-20" },
  { src: FiestaAmericanaLogo, alt: "Fiesta Americana", height: "h-12" },
  { src: GDLLogo, alt: "Gobierno de Guadalajara", height: "h-20" },
  { src: GPLogo, alt: "GP", height: "h-20" },
  { src: IEPCJaliscoLogo, alt: "IEPC Jalisco", height: "h-12" },
  { src: JoyaLogo, alt: "Joya", height: "h-12" },
  { src: TlajomulcoLogo, alt: "Tlajomulco", height: "h-20" },
  { src: MaverLogo, alt: "Maver", height: "h-12" },
  { src: MITLogo, alt: "MIT", height: "h-12" },
  { src: PeninsulaLogo, alt: "Peninsula Residences", height: "h-28" },
  { src: PresidenteLogo, alt: "Presidente Continental México", height: "h-20" },
  { src: QINLogo, alt: "QIN", height: "h-12" },
  { src: TlaquepaqueLogo, alt: "Tlaquepaque", height: "h-20" },
  { src: ZapopanLogo, alt: "Zapopan", height: "h-18" },
  { src: ZFLogo, alt: "ZF", height: "h-20" },
];
---

<section class="bg-white" id="sobre-une-section">
  <!-- Header Section -->
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-16">
    <div class="flex justify-between items-center">
      <div>
        <h2 class="text-3xl font-bold text-gray-900 mb-2">SOMOS UNE</h2>
        <p class="text-gray-600">Nuestra historia</p>
      </div>
      <div class="flex items-center hover:text-blue-800 transition-colors">
        <a href="/vidaestudiantil/General" class="mr-2" aria-label="Ir a Explora UNE" title="Explora UNE">Explora UNE</a>
        <ArrowRight
          class="border border-black text-black w-6 h-6 p-1 rounded-full group-hover:bg-white group-hover:text-azul-une group-hover:shadow-lg transition-all duration-300 flex-shrink-0"
        />
      </div>
    </div>

    <!-- UNE Logo and Description -->
    <div class="text-center mb-16">
      <div class="mb-8">
        <img
          src={UNELogo.src}
          alt="UNE Logo"
          class="mx-auto h-72 w-auto"
          loading="eager"
          fetchpriority="high"
          width={UNELogo.width}
          height={UNELogo.height}
        />
      </div>

      <p class="text-gray-700 text-lg max-w-4xl mx-auto leading-relaxed">
        La Universidad de especialidades UNE es una institución líder en
        formación integral, reconocida por su innovación académica, vinculación
        internacional y compromiso con el desarrollo social.
      </p>
    </div>

    <!-- Partner Logos Carousel - Inicialmente oculto -->
    <div class="mb-16" id="carousel-container">
      <!-- Loading placeholder -->
      <div id="carousel-loading" class="flex justify-center items-center h-32">
        <div class="animate-pulse text-gray-500">
          Cargando convenios...
        </div>
      </div>

      <!-- Carousel real - se carga dinámicamente -->
      <div class="splide hidden" id="partners-carousel" aria-label="Partners Carousel">
        <div class="splide__track">
          <ul class="splide__list">
            {
              partnerLogos.map((logo) => (
                <li class="splide__slide">
                  <img
                    src={logo.src.src}
                    alt={logo.alt}
                    class={`${logo.height} w-auto opacity-70 hover:opacity-100 transition-opacity mx-auto lazy-load`}
                    loading="lazy"
                    decoding="async"
                    width={logo.src.width}
                    height={logo.src.height}
                  />
                </li>
              ))
            }
          </ul>
        </div>
      </div>

      <div class="text-center mt-8">
        <p class="text-gray-700 text-lg">
          <span class="text-red-500 font-bold">Más de 800</span> convenios con
          <span class="font-semibold">empresas</span> para la formación de sus equipos
        </p>
      </div>
    </div>
  </div>


</section>

<style>
  /* Estilos para el carousel */
  .splide {
    max-width: 100%;
  }

  .splide__slide {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0 20px;
  }

  .splide__slide img {
    max-width: 100%;
    height: auto;
    object-fit: contain;
    opacity: 0;
    transition: opacity 0.3s ease;
  }

  .splide__slide img.loaded {
    opacity: 0.7;
  }

  .splide__slide img.loaded:hover {
    opacity: 1;
  }

  /* Loading skeleton */
  .lazy-load:not(.loaded) {
    background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
    background-size: 200% 100%;
    animation: loading 1.5s infinite;
  }

  @keyframes loading {
    0% {
      background-position: 200% 0;
    }
    100% {
      background-position: -200% 0;
    }
  }

  /* Reduce motion for users who prefer it */
  @media (prefers-reduced-motion: reduce) {
    .splide {
      animation: none;
    }
    
    .splide__slide img {
      transition: none;
    }

    .lazy-load:not(.loaded) {
      animation: none;
      background: #f0f0f0;
    }
  }

  .gradient-bg {
    background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%);
  }

  /* Smooth reveal animation */
  #partners-carousel {
    transition: opacity 0.5s ease, transform 0.5s ease;
  }

  #partners-carousel.hidden {
    opacity: 0;
    transform: translateY(20px);
  }

  #partners-carousel.visible {
    opacity: 1;
    transform: translateY(0);
  }
</style>

<!-- Preload only critical images -->
<link rel="preload" as="image" href={UNELogo.src} />
<link rel="preload" as="image" href={Numeralia.src} />

<script>
  // Cargar Splide y AutoScroll dinámicamente
  let splideLoaded = false;
  let autoScrollLoaded = false;
  let splideInstance = null;

  async function loadSplideLibraries() {
    if (!splideLoaded || !autoScrollLoaded) {
      const [{ Splide }, { AutoScroll }] = await Promise.all([
        import("@splidejs/splide"),
        import("@splidejs/splide-extension-auto-scroll")
      ]);
      
      splideLoaded = true;
      autoScrollLoaded = true;
      
      return { Splide, AutoScroll };
    }
  }

  function loadImage(img) {
    return new Promise((resolve) => {
      // Como ya tenemos el src correcto, solo aplicamos la clase loaded
      img.classList.add('loaded');
      resolve();
    });
  }

  async function initializeCarousel() {
    try {
      // Cargar las librerías de Splide
      const { Splide, AutoScroll } = await loadSplideLibraries();
      
      // Cargar las imágenes del carousel
      const carouselImages = document.querySelectorAll('#partners-carousel .lazy-load');
      const imagePromises = Array.from(carouselImages).map(img => loadImage(img));
      
      // Esperar a que se carguen las primeras imágenes (al menos las visibles)
      await Promise.allSettled(imagePromises.slice(0, 5));
      
      // Ocultar el loading y mostrar el carousel
      const loadingElement = document.getElementById('carousel-loading');
      const carouselElement = document.getElementById('partners-carousel');
      
      if (loadingElement) loadingElement.style.display = 'none';
      if (carouselElement) {
        carouselElement.classList.remove('hidden');
        carouselElement.classList.add('visible');
      }

      // Verificar preferencias de movimiento
      const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
      
      // Configurar el carousel
      splideInstance = new Splide("#partners-carousel", {
        type: "loop",
        drag: "free",
        focus: "center",
        perPage: 5,
        perMove: 1,
        gap: "1rem",
        arrows: false,
        pagination: false,
        autoScroll: prefersReducedMotion ? false : {
          speed: 0.5,
          pauseOnHover: true,
          pauseOnFocus: true,
          rewind: false,
        },
        breakpoints: {
          1024: {
            perPage: 4,
          },
          768: {
            perPage: 3,
          },
          480: {
            perPage: 2,
          },
        },
      });

      // Montar el carousel
      if (!prefersReducedMotion) {
        splideInstance.mount({ AutoScroll });
      } else {
        splideInstance.mount();
      }

      // Cargar las imágenes restantes en background
      Promise.allSettled(imagePromises.slice(5));

    } catch (error) {
      console.error('Error inicializando el carousel:', error);
      
      // Fallback: mostrar el carousel sin animación
      const loadingElement = document.getElementById('carousel-loading');
      const carouselElement = document.getElementById('partners-carousel');
      
      if (loadingElement) loadingElement.style.display = 'none';
      if (carouselElement) {
        carouselElement.classList.remove('hidden');
        carouselElement.classList.add('visible');
      }
    }
  }

  // Configurar el Intersection Observer
  function setupIntersectionObserver() {
    const sectionElement = document.getElementById('sobre-une-section');
    
    if (!sectionElement) return;

    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          // El componente está visible, inicializar el carousel
          initializeCarousel();
          
          // Desconectar el observer ya que solo necesitamos cargar una vez
          observer.unobserve(entry.target);
        }
      });
    }, {
      // Empezar a cargar cuando esté a 100px de entrar en pantalla
      rootMargin: '100px 0px',
      threshold: 0.1
    });

    observer.observe(sectionElement);

    // Cleanup
    window.addEventListener('beforeunload', () => {
      observer.disconnect();
      if (splideInstance) {
        splideInstance.destroy();
      }
    });
  }

  // Inicializar cuando el DOM esté listo
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', setupIntersectionObserver);
  } else {
    setupIntersectionObserver();
  }
</script>